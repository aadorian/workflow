name: Pre-Push Validation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate:
    name: Validate CWL and RO-Crate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install cwltool
        run: pip install cwltool
      
      - name: Validate all CWL files
        run: |
          echo "ğŸ” Validating CWL files..."
          cwl_files=$(find . -name "*.cwl" -not -path "./ro-crate/*" -not -path "./.git/*" -not -path "./node_modules/*")
          
          if [ -z "$cwl_files" ]; then
            echo "âš ï¸  No CWL files found to validate"
            exit 1
          fi
          
          validation_failed=false
          for cwl_file in $cwl_files; do
            echo "Validating $cwl_file..."
            if ! cwltool --validate "$cwl_file"; then
              echo "âŒ Validation failed for $cwl_file"
              validation_failed=true
            else
              echo "âœ… $cwl_file is valid"
            fi
          done
          
          if [ "$validation_failed" = true ]; then
            echo "âŒ CWL validation failed"
            exit 1
          fi
          
          echo "âœ… All CWL files are valid"
      
      - name: Build RO-Crate
        run: |
          echo "ğŸ“¦ Building RO-Crate..."
          npm run ro-crate:build || exit 1
          echo "âœ… RO-Crate built successfully"
      
      - name: Validate RO-Crate structure
        run: |
          echo "ğŸ” Validating RO-Crate structure..."
          
          # Check RO-Crate directory exists
          if [ ! -d "ro-crate" ]; then
            echo "âŒ RO-Crate directory not found"
            exit 1
          fi
          
          # Check required files exist
          required_files=(
            "ro-crate/ro-crate-metadata.json"
            "ro-crate/pizza.cwl"
            "ro-crate/pizza-job.json"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file not found: $file"
              exit 1
            fi
            echo "âœ… Found: $file"
          done
          
          echo "âœ… RO-Crate structure is valid"
      
      - name: Validate RO-Crate metadata JSON
        run: |
          echo "ğŸ” Validating RO-Crate metadata JSON..."
          if ! python3 -c "import json; json.load(open('ro-crate/ro-crate-metadata.json'))" 2>/dev/null; then
            echo "âŒ RO-Crate metadata JSON is invalid"
            exit 1
          fi
          echo "âœ… RO-Crate metadata JSON is valid"
      
      - name: Validate CWL in RO-Crate
        run: |
          echo "ğŸ” Validating CWL files in RO-Crate..."
          if [ -f "ro-crate/pizza.cwl" ]; then
            if ! cwltool --validate ro-crate/pizza.cwl; then
              echo "âŒ CWL file in RO-Crate is invalid"
              exit 1
            fi
            echo "âœ… CWL file in RO-Crate is valid"
          fi
      
      - name: Test RO-Crate workflow execution
        run: |
          echo "ğŸ§ª Testing RO-Crate workflow execution..."
          if [ -f "ro-crate/pizza.cwl" ] && [ -f "ro-crate/pizza-job.json" ]; then
            cd ro-crate
            if ! cwltool pizza.cwl pizza-job.json; then
              echo "âŒ RO-Crate workflow execution failed"
              exit 1
            fi
            echo "âœ… RO-Crate workflow executed successfully"
          else
            echo "âš ï¸  RO-Crate workflow files not found, skipping execution test"
          fi
      
      - name: Check for RO-Crate git tag
        run: |
          echo "ğŸ” Checking for RO-Crate git tag..."
          # This is informational - tags are created during build
          if git rev-parse "ro-crate-v$(node -p "require('./package.json').version")" >/dev/null 2>&1; then
            echo "âœ… RO-Crate tag exists"
          else
            echo "â„¹ï¸  RO-Crate tag not found (this is normal for new builds)"
          fi
      
      - name: Validation Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Pre-push validation completed successfully"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "All checks passed:"
          echo "  âœ“ CWL files validated"
          echo "  âœ“ RO-Crate built"
          echo "  âœ“ RO-Crate structure validated"
          echo "  âœ“ RO-Crate metadata validated"
          echo "  âœ“ RO-Crate workflow tested"

